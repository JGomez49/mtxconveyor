<!--  -->

<%- include ('partials/header.ejs') %>

<style>
    .pie-row {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;        /* allows wrapping on small screens */
    justify-content: center;
    margin-top: 16px;
    }
    .pie-chart {
        max-width: 300px;
        max-height: 300px;
    }
</style>


<div id="navbar" class="p-2">
    <% if (user.name != 'Guest') { %>

        <% if (user.role == 'admin') { %>
            <%- include ('partials/navigation_Admin.ejs') %>
        <% } %>

        <% if (user.role == 'leader' || user.role == 'user') { %>
            <%- include ('partials/navigation_Leader.ejs') %>
        <% } %>

        <% if (user.role == 'viewer') { %>
            <%- include ('partials/navigation_Member.ejs') %>
        <% } %>

    <% } %>
</div>



<div class="container_ p-4">

    <%- include ('avatar.ejs') %>

    <h3 id="greeting"><%= user.name %></h3>
    <!-- <p style="color: black;"> ID: <%= user.id %></p> -->
      <p style="color: gray;"><%= user.role %></p>
    <!-- <p style="color: gray;"> Role: <%= user.role %> <br> Rank: <%= user.rank %> <br><%= user.list %></p> -->
    <!-- <p style="color: gray;"> <%= user.rank %> <br><%= user.list %></p> -->

    <!-- <h1 style="color: whitesmoke;">Jobs</h1> -->

    <% if (user.role == 'admin' || user.role == 'leader' || user.name == 'Camilo' || user.name == 'Johanna') { %>
        <a class="btn btn-warning btn-block my-2" href="/notes/add">New Job</a>
        <!-- <pre><%= notes %></pre> -->
         
    <% } %>


    <div class="row">

        <div class="accordion accordion-flush my-4 small" id="accordionExample">


            <!-- <div id="dpBoxPlot" style="width:100%; max-width:100%;"></div> -->


            <div id="dpBoxPlot" style="width:100%;"></div>


            
            <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' || user.role == 'viewer') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseOne" 
                                aria-expanded="true" 
                                aria-controls="collapseOne">
                            <h4 style="color: white;">Not Started</h4>
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">


                            <h4>Design</h4>

                            <table class="table table-hover _table-striped table-dark table-sm" style="color: gray;">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Q</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <th scope="col">Resp.</th> -->
                                        <!-- <th scope="col">Created</th> -->
                                        <th scope="col">Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>

                                        <% if (user.role == 'admin' || user.role == 'leader' || user.name == note.responsible || user.list == note.customer) { %> 

                                            <% if (note.status == 'Not Started' && (note.title != "Offsets+Subject" && note.title != "Offsets" && note.title != "Subject")) { %>

                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                    <% if (note.title == "Execution") { %>
                                                        <tr style="color: green;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>  
                                                    <% if (note.responsible == "Orphan") { %>
                                                        <tr style="color: white;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   
                                                    <% if (user.name == note.responsible) { %>
                                                        <tr style="color: red;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>

                                                    <th scope="row">
                                                        <% if (user.role == 'admin' || user.role == '_leader') { %>
                                                            <% if (note.responsible == "Camilo") { %>
                                                                <span class="dotCamilo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Johanna") { %>
                                                                <span class="dotJohanna"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Daniel") { %>
                                                                <span class="dotDaniel"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Pablo") { %>
                                                                <span class="dotPablo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Sammy") { %>
                                                                <span class="dotSammy"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Polita") { %>
                                                                <span class="dotPolita"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "John") { %>
                                                                <span class="dotJohn"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Orphan") { %>
                                                                <span class="dotOrphan"></span>
                                                            <% } %>
                                                        <% } %> 

                                                        <small><%= note.mtxJobId %></small>
                                                    </th>

                                                    <td><%= count_NotStarted = count_NotStarted + 1 %></td>
                                                    <td><%= note.title %></td>                                                
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>

                                                    <!-- <% if (user.name == note.responsible) { %>
                                                        <td style="color: red;"><%= note.project%></td>
                                                    <% } %>
                                                    <% if (user.name != note.responsible) { %>
                                                        <td><%= note.project %></td>
                                                    <% } %>  -->

                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <td><%= note.responsible %></td> -->
                                                    <!-- <td><small><%= note.created %></small></td> -->
                                                    <td><small><%= note.dueDate %></small></td>
                                                </tr>
                                            <% } %>                             
                                        <% } %>


                                    <% }) %> 
                                </tbody>
                            </table>


                            <h4>Set up</h4>

                            <table class="table table-hover _table-striped table-dark table-sm" style="color: gray;">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Q</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <th scope="col">Resp.</th> -->
                                        <!-- <th scope="col">Created</th> -->
                                        <th scope="col">Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>

                                        <% if (user.role == 'admin' || user.role == 'leader' || user.name == note.responsible || user.list == note.customer) { %> 

                                            <% if (note.status == 'Not Started' && (note.title == "Offsets+Subject" || note.title == "Offsets" || note.title == "Subject")) { %>

                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                    <% if (note.title == "Execution") { %>
                                                        <tr style="color: green;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>  
                                                    <% if (note.responsible == "Orphan") { %>
                                                        <tr style="color: white;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   
                                                    <% if (user.name == note.responsible) { %>
                                                        <tr style="color: red;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>

                                                    <th scope="row">
                                                        <% if (user.role == 'admin' || user.role == '_leader') { %>
                                                            <% if (note.responsible == "Camilo") { %>
                                                                <span class="dotCamilo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Johanna") { %>
                                                                <span class="dotJohanna"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Daniel") { %>
                                                                <span class="dotDaniel"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Pablo") { %>
                                                                <span class="dotPablo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Sammy") { %>
                                                                <span class="dotSammy"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Polita") { %>
                                                                <span class="dotPolita"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "John") { %>
                                                                <span class="dotJohn"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Orphan") { %>
                                                                <span class="dotOrphan"></span>
                                                            <% } %>
                                                        <% } %> 

                                                        <small><%= note.mtxJobId %></small>
                                                    </th>

                                                    <td><%= count_NotStarted_setup = count_NotStarted_setup + 1 %></td>
                                                    
                                                    <td><%= note.title %></td>                                                
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>

                                                    <!-- <% if (user.name == note.responsible) { %>
                                                        <td style="color: red;"><%= note.project%></td>
                                                    <% } %>
                                                    <% if (user.name != note.responsible) { %>
                                                        <td><%= note.project %></td>
                                                    <% } %>  -->

                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <td><%= note.responsible %></td> -->
                                                    <!-- <td><small><%= note.created %></small></td> -->
                                                    <td><small><%= note.dueDate %></small></td>
                                                </tr>
                                            <% } %>                             
                                        <% } %>
                                    <% }) %> 
                                </tbody>
                            </table>

                        </div>
                    </div> 
                </div>
            <% } %>








            <% if (user.role == 'admin' || user.role == 'leader'|| user.role == 'user' || user.role == 'viewer') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseTwo" 
                                aria-expanded="true" 
                                aria-controls="collapseTwo">
                            <h4 id="ID_InProgress" style="color:aqua;">In Progress</h4>
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">
                            <table class="table table-hover _table-striped table-dark _table-primary table-sm" style="color: gray;" id="InProgressTable">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Q</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <% if (user.role == 'admin' || user.role == 'leader') { %>
                                            <th scope="col">Resp.</th>
                                        <% } %> -->
                                        <!-- <th scope="col">Created</th> -->
                                        <th scope="col">Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>

                                        <% if ( user.role == 'admin' || 
                                                user.role == 'leader' || 
                                                user.name == note.responsible || 
                                                user.list == note.customer) { %>

                                                <% if (note.status == 'In Progress' 
                                                    && note.title != 'Exe-Review'
                                                    && note.title != 'Execution' 
                                                    && note.title != 'Exe-QC' 
                                                    && note.title != 'Exe-Vendor') { %>

                                                    <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                        <% if (note.responsible == "Orphan") { %>
                                                            <tr style="color: white;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                        <% } %>   
                                                        <% if (user.name == note.responsible) { %>
                                                            <tr style="color: red;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                        <% } %>   
                                                                                            
                                                        <th scope="row">
                                                            <% if (user.role == 'admin' || user.role == '_leader') { %>
                                                                <% if (note.responsible == "Camilo") { %>
                                                                    <span class="dotCamilo"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "Johanna") { %>
                                                                    <span class="dotJohanna"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "Daniel") { %>
                                                                    <span class="dotDaniel"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "Pablo") { %>
                                                                    <span class="dotPablo"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "Sammy") { %>
                                                                    <span class="dotSammy"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "Polita") { %>
                                                                    <span class="dotPolita"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "John") { %>
                                                                    <span class="dotJohn"></span>
                                                                <% } %>
                                                                <% if (note.responsible == "Orphan") { %>
                                                                    <span class="dotOrphan"></span>
                                                                <% } %>
                                                            <% } %> 
                                                            <small><%= note.mtxJobId %></small>
                                                        </th> 

                                                        <td><%= count_InProgress = count_InProgress + 1 %></td>

                                                        <td><%= note.title %></td>
                                                        <td><%= note.customerJobNumber %></td>
                                                        <td><%= note.project %></td>
                                                        <td><%= note.area %></td>
                                                        <td><%= note.wells %></td>
                                                        <!-- <td><%= note.budget %></td> -->
                                                        <td><%= note.poc %></td>
                                                        <td><%= note.geologist %></td>
                                                        <td><%= note.rig %></td>
                                                        <!-- <% if (user.role == 'admin' || user.role == 'leader') { %>
                                                            <td><%= note.responsible %></td>
                                                        <% } %> -->
                                                        <!-- <td><small><%= note.created %></small></td> -->
                                                        <td><small><%= note.dueDate %></small></td>
                                                    </tr>
                                                <% } %>  
                                            <% } %> 
                                    <% }) %> 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>




            <!-- ----------------------------- -->


            <% if (user.role == 'admin' || user.role == 'leader'|| user.role == 'user' || user.role == 'viewer') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark_" style="background-color: black;"
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseTwo" 
                                aria-expanded="true" 
                                aria-controls="collapseTwo">
                            <h4 style="color:red;">Execution</h4>
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">
                            <table class="table table-hover _table-striped table-dark _table-primary table-sm" style="color: gray;">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <th scope="col">Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>
                                        <% if (user.role == 'admin' || user.role == 'leader' || 
                                            user.name == note.responsible || user.list == note.customer) { %>

                                            <% if ((note.status == 'In Progress')
                                            && (note.title == 'Exe-Review'
                                            || note.title == 'Execution'
                                            || note.title == 'Exe-QC'
                                            || note.title == 'Exe-Vendor')) { %>

                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                    <% if (note.responsible == "Orphan") { %>
                                                        <tr style="color: white;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   
                                                    <% if (user.name == note.responsible) { %>
                                                        <tr style="color: red;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   
                                                                                        
                                                    <th scope="row">
                                                        <% if (user.role == 'admin' || user.role == '_leader') { %>
                                                            <% if (note.responsible == "Camilo") { %>
                                                                <span class="dotCamilo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Johanna") { %>
                                                                <span class="dotJohanna"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Daniel") { %>
                                                                <span class="dotDaniel"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Pablo") { %>
                                                                <span class="dotPablo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Sammy") { %>
                                                                <span class="dotSammy"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Polita") { %>
                                                                <span class="dotPolita"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "John") { %>
                                                                <span class="dotJohn"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Orphan") { %>
                                                                <span class="dotOrphan"></span>
                                                            <% } %>
                                                        <% } %> 

                                                        <small><%= note.mtxJobId %></small>
                                                    </th>
                                                     
                                                    <td><%= note.title %></td>
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>
                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <% if (user.role == 'admin' || user.role == 'leader') { %>
                                                        <td><%= note.responsible %></td>
                                                    <% } %> -->
                                                    <!-- <td><small><%= note.created %></small></td> -->
                                                    <td><small><%= note.dueDate %></small></td>
                                                </tr>
                                            <% } %>  
                                        <% } %>                   
                                    <% }) %> 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>




            <!-- ----------------------------- -->


            <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseThree" 
                                aria-expanded="true" 
                                aria-controls="collapseThree">
                            <h4 style="color: grey;">On Hold</h4>
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">
                            <table class="table table-hover _table-striped _table-danger table-dark table-sm" style="color: gray;">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <th scope="col">Resp.</th> -->
                                        <!-- <th scope="col">Created</th> -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>
                                        <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' 
                                            || user.name == note.responsible || user.list == note.customer) { %>
                                            <% if (note.status == 'On Hold') { %>

                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                    <% if (note.title == "Execution") { %>
                                                        <tr style="color: green;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>  
                                                    <% if (note.responsible == "Orphan") { %>
                                                        <tr style="color: white;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   
                                                    <% if (user.name == note.responsible) { %>
                                                        <tr style="color: red;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %> 

                                                    <th scope="row"><small><%= note.mtxJobId %></small></th>
                                                    <td><%= note.title %></td>
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>
                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <td><%= note.responsible %></td> -->
                                                    <!-- <td><small><%= note.created %></small></td> -->
                                                </tr>
                                            <% } %> 
                                        <% } %>                    
                                    <% }) %> 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>





            <% if (user.role == 'admin' || user.role == 'leader' || user.role == '_user') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseFour" 
                                aria-expanded="true" 
                                aria-controls="collapseFour">
                            <h4 style="color: orange;">QA/QC</h4>
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark table-sm">
                            <table class="table table-hover _table-striped _table-warning table-dark" style="color: gray;">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <th scope="col">Resp.</th> -->
                                        <!-- <th scope="col">Created</th> -->
                                        <th scope="col">Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>
                                        <% if (user.role == 'admin' || user.role == 'leader' || user.name == note.responsible || user.list == note.customer) { %>
                                            <% if (note.status == 'QA/QC') { %>
                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                    <!-- <% if (note.title == "Execution") { %>
                                                        <tr style="color: green;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   -->
                                                    <% if (note.responsible == "Orphan") { %>
                                                        <tr style="color: white;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %>   
                                                    <% if (user.name == note.responsible) { %>
                                                        <tr style="color: red;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %> 

                                                    <th scope="row">

                                                        <% if (user.role == 'admin' || user.role == '_leader') { %>
                                                            <% if (note.responsible == "Camilo") { %>
                                                                <span class="dotCamilo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Johanna") { %>
                                                                <span class="dotJohanna"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Daniel") { %>
                                                                <span class="dotDaniel"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Pablo") { %>
                                                                <span class="dotPablo"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Sammy") { %>
                                                                <span class="dotSammy"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Polita") { %>
                                                                <span class="dotPolita"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "John") { %>
                                                                <span class="dotJohn"></span>
                                                            <% } %>
                                                            <% if (note.responsible == "Orphan") { %>
                                                                <span class="dotOrphan"></span>
                                                            <% } %>
                                                        <% } %> 
                                                        
                                                        <small><%= note.mtxJobId %></small>
                                                    </th>

                                                    <td><%= note.title %></td>
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>
                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <td><%= note.responsible %></td> -->
                                                    <!-- <td><small><%= note.created %></small></td> -->
                                                    <td><small><%= note.dueDate %></small></td>
                                                </tr>
                                            <% } %>  
                                        <% } %>                   
                                    <% }) %> 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>






            <% if (user.role == 'admin' || user.role == 'leader') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseFive" 
                                aria-expanded="true" 
                                aria-controls="collapseFive">
                            <h4 style="color:chartreuse;">Completed</h4>
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark table-sm">
                            <table class="table table-hover _table-striped table-dark" style="color: greenyellow;">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Vers.</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <th scope="col">Resp.</th> -->
                                        <!-- <th scope="col">Created</th> -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>
                                        <% if (user.role == 'admin' || user.role == 'leader' || user.name == note.responsible || user.list == note.customer) { %>
                                            <% if (note.status == 'Completed') { %>
                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">

                                                    <!-- <% if (user.name == note.responsible) { %>
                                                        <tr style="color: blue;" onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <% } %> -->

                                                    <th scope="row"><small><%= note.mtxJobId %></small></th>
                                                    <td><%= note.title %></td>
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>
                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <td><%= note.responsible %></td> -->
                                                    <!-- <td><small><%= note.created %></small></td> -->
                                                </tr>
                                            <% } %> 
                                        <% } %>                   
                                    <% }) %> 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>







            <% if (user.role == 'admin' && (user.name == "John" || user.name == "Polita") || user.name == "Sammy") { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseSix" 
                                aria-expanded="true" 
                                aria-controls="collapseSix">
                            <h4 style="color: black;">Archived</h4>
                        </button>
                    </h2>
                    <div id="collapseSix" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">
                            <table class="table table-hover table-striped table-dark table-sm">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Task</th>
                                        <th scope="col">Cust.</th>
                                        <th scope="col">C.ID</th>
                                        <th scope="col">Project</th>
                                        <th scope="col">Area</th>
                                        <th scope="col">Wells</th>
                                        <!-- <th scope="col">Budget</th> -->
                                        <th scope="col">D.E</th>
                                        <th scope="col">Geo</th>
                                        <th scope="col">Rig</th>
                                        <!-- <th scope="col">Resp.</th> -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <% notes.forEach(note => { %>
                                        <% if (user.role == 'admin' || user.name == note.responsible || user.list == note.customer) { %>
                                            <% if (note.status == 'Billed' || note.status == 'Archived') { %>
                                                <tr onclick="window.location.href='/notes/job/<%= note._id %>';">
                                                    <th scope="row"><small><%= note.mtxJobId %></small></th>
                                                    <td><%= note.title %></td>
                                                    <td><%= note.customer %></td>
                                                    <td><%= note.customerJobNumber %></td>
                                                    <td><%= note.project %></td>
                                                    <td><%= note.area %></td>
                                                    <td><%= note.wells %></td>
                                                    <!-- <td><%= note.budget %></td> -->
                                                    <td><%= note.poc %></td>
                                                    <td><%= note.geologist %></td>
                                                    <td><%= note.rig %></td>
                                                    <!-- <td><%= note.responsible %></td> -->
                                                    <!-- <td><small><%= note.dueDate %></small></td> -->
                                                </tr>
                                            <% } %> 
                                        <% } %>                    
                                    <% }) %> 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>







            <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' || user.role == 'viewer') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseSchedule" 
                                aria-expanded="true"
                                aria-controls="collapseSchedule">
                            <h4 style="color: blue;">Schedule</h4>
                        </button>
                    </h2>
                    <div id="collapseSchedule" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">
                            <div class="accordion mb-4" id="accordionExample">
                                <div class="accordion-item bg-dark border-0">
                                    <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            style="background-color: #1a1a1a; color: #ffffff;" 
                                            data-bs-target="#collapseTable" 
                                            aria-expanded="true"
                                            aria-controls="collapseTable">
                                             Schedule Table
                                        </button>
                                    </h2>


                                    <% if (user.role != 'viewer') { %>
                                        <!-- <button class="btn btn-primary my-2" onclick="addNoteIds()">Add Note IDs</button> -->
                                        <!-- <button class="btn btn-primary my-2" onclick="loadScheduleAndNotes()">Load Schedule & Notes</button> -->
                                        <!-- <button class="btn btn-primary my-2" onclick="appendNoteIds()">Add Note IDs</button> -->
                                        <button class="btn btn-warning my-2" onclick="syncDueDates()"> Sync Due Dates</button>
                                    <% } %>

                                    <div id="collapseTable" class="accordion-collapse collapse _show" aria-labelledby="headingOne">
                                        <div class="accordion-body">
                                            <table 
                                                id="csvTable" 
                                                class="table table-dark table-striped table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Rig</th>
                                                        <th>DrillOK</th>
                                                        <th>GeoOK</th>
                                                        <th>DP</th>
                                                        <th>Type</th>
                                                        <th>Duration</th>
                                                        <th>VP</th>
                                                        <th>Start</th>
                                                        <th>Site</th>
                                                        <th>Well</th>
                                                        <th>DP Company</th>
                                                        <th>ETS</th>
                                                        <th>Group</th>
                                                        <th>DpReq</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% schedule.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.rig %></td>
                                                            <td><%= item.drillok %></td>
                                                            <td><%= item.geook %></td>
                                                            <td><%= item.dp %></td>
                                                            <td><%= item.type %></td>
                                                            <td><%= item.duration %></td>
                                                            <td><%= item.vp %></td>
                                                            <td><%= item.start %></td>
                                                            <td><%= item.site %></td>
                                                            <td><%= item.well %></td>
                                                            <td><%= item.dpCompany %></td>
                                                            <td><%= item.ETS %></td>
                                                            <td><%= item.group %></td>
                                                            <td><%= item.dpReq %></td>
                                                        </tr>
                                                    <% }) %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>







            <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' || user.role == 'viewer') { %>
                <div class="accordion-item">
                    <h2 class="accordion-header bg-dark">
                        <button class="accordion-button collapsed bg-dark" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapseDPStats" 
                                aria-expanded="true"
                                aria-controls="collapseDPStats">
                            <h4 style="color: blueviolet;">DP Stats</h4>
                        </button>
                    </h2>
                    <div id="collapseDPStats" class="accordion-collapse collapse show_" data-bs-parent="#accordionExample">
                        <div class="accordion-body bg-dark">
                            <div class="accordion mb-4" id="accordionExample">
                                <div class="accordion-item bg-dark border-0">
                                    <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            style="background-color: #1a1a1a; color: #ffffff;" 
                                            data-bs-target="#collapseTable" 
                                            aria-expanded="true"
                                            aria-controls="collapseTable">
                                             Stats Table
                                        </button>
                                    </h2>
                                    <div id="collapseTable" class="accordion-collapse collapse _show" aria-labelledby="headingOne">
                                        <div class="accordion-body">
                                            <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' || user.role == 'viewer') { %>

                                                <!-- <button class="btn btn-info my-2" onclick="renderDPStatsBoxPlot();"> Show Stats</button>

                                                <div id="dpBoxPlot" style="width:100%;max-width:100%;"></div> -->

                                            <% } %>
                                            <table 
                                                id="DPStatsTable" 
                                                class="table table-dark table-striped table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>DP Version</th>
                                                        <th>DP Days</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% dpStats.forEach(item => { %>
                                                        <tr>
                                                            <td><%= item.dpVersion %></td>
                                                            <td><%= item.dpDays %></td>
                                                        </tr>
                                                    <% }) %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>

            <p id="scheduleUpdateText"></p>
            <div id="chartDiv" class="m-3 bg-dark"></div>

        </div>
    </div>

    <!-- <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' || user.role == 'viewer') { %>
        <p id="scheduleUpdateText"></p>
        <button class="btn btn-info my-2" onclick="renderChartsFromTable()"> Show Schedule</button>
        <div id="chartDiv" class="m-3 bg-dark"></div>
    <% } %> -->


    <!-- <% if (user.role == 'admin' || user.role == 'leader' || user.role == 'user' || user.role == 'viewer') { %>                            
        <button class="btn btn-info my-2" onclick="renderDPStatsBoxPlot();"> Show Stats</button>
    <% } %> -->

    <!-- <div id="dpBoxPlot" style="width:100%;max-width:100%;"></div> -->
</div>











<!-- Script to generate the Charts -->

<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderDPStatsBoxPlot();
        renderChartsFromTable();
    });
</script>

<script>

    let chartInstances = [];

    function parseDate(value) {
        const parsed = Date.parse(value);
        if (!isNaN(parsed)) return new Date(parsed);
        return null;
    }

    function renderChartsFromTable() {

        // appendNoteIds() // Note IDs are added

        document.getElementById("scheduleUpdateText").innerText = "Updated on: <%= schedule.length > 0 ? schedule[1].uploadedDate : 'N/A' %>";

        function getInProgressSites() {
            const table = document.getElementById("InProgressTable");
            if (!table) return new Set();

            // const rows = Array.from(table.querySelectorAll("tbody tr"));
            const rows = Array.from(table.querySelectorAll("tr"));
            const siteSet = new Set();

            rows.forEach(row => {
                const cells = row.querySelectorAll("td");
                if (!cells.length) return;

                //  Adjust index if Site column is not the first one
                const siteValue = cells[3]?.innerText.trim();
                if (siteValue) {
                    siteSet.add(siteValue.slice(0, 14)); // normalize like everywhere else
                }
            });

            return siteSet;
        }

        const inProgressSites = getInProgressSites();
        const table = document.getElementById("csvTable");
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const vpMap = {};

        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            const rig = cells[0]?.innerText.trim();
            const drillok = cells[1]?.innerText.trim();
            const geook = cells[2]?.innerText.trim();
            const dp = cells[3]?.innerText.trim();
            const type = cells[4]?.innerText.trim();
            const duration = Number(cells[5]?.innerText.trim() || 0);
            const vp = cells[6]?.innerText.trim();
            const start = parseDate(cells[7]?.innerText.trim());
            const site = cells[8]?.innerText.trim();
            const well = cells[9]?.innerText.trim();
            const dpCompany = cells[10]?.innerText.trim();
            const ETS = cells[11]?.innerText.trim();
            const group = cells[12]?.innerText.trim().substring(0, 2);
            const dpReq = cells[13]?.innerText.trim();

            // if (!start) return;
            // if (!vpMap[vp]) vpMap[vp] = {};
            // if (!vpMap[vp][rig]) vpMap[vp][rig] = [];
            // vpMap[vp][rig].push({ rig, drillok, geook, dp, type, duration, vp, start, site, well, dpCompany, ETS, group });

            if (!vpMap[vp]) vpMap[vp] = {};
            if (!vpMap[vp][group]) vpMap[vp][group] = {};
            if (!vpMap[vp][group][rig]) vpMap[vp][group][rig] = [];

            vpMap[vp][group][rig].push({
                rig, drillok, geook, dp, type, duration,
                vp, start, site, well, dpCompany, ETS, group, dpReq,
            });

        });

        const today = new Date();
        const twoMonthsLater = new Date(today.getFullYear(), today.getMonth() + 2, today.getDate());
        const threeMonthsLater = new Date(today.getFullYear(), today.getMonth() + 3, today.getDate());
        const fourMonthsLater = new Date(today.getFullYear(), today.getMonth() + 4, today.getDate());
        const sixMonthsLater = new Date(today.getFullYear(), today.getMonth() + 6, today.getDate());
        const nineMonthsLater = new Date(today.getFullYear(), today.getMonth() + 9, today.getDate());
        const oneYearLater = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());

        const chartDiv = document.getElementById("chartDiv");
        chartDiv.innerHTML = "";


        // Sort VPs alphabetically
        Object.keys(vpMap).sort((a, b) => a.localeCompare(b));

        Object.keys(vpMap).forEach(vp => {

            ["BV", "FB"].forEach(group => {
                
                if (!vp ) return;
                if (!vpMap[vp][group]) return;

                // const rigs = Object.keys(vpMap[vp]);
                const rigs = Object.keys(vpMap[vp][group]).sort((a, b) => a.localeCompare(b)); //  alphabetical

                const colorOfBorder = "#000000";
                const datasets = [];
                const colors = [];
                const colorCounts = { 
                    blue: 0, 
                    red: 0, 
                    green: 0, 
                    yellow: 0,
                    purple: 0,
                    white: 0,
                    black: 0,
                    silver: 0,

                    blueThisYear: 0, 
                    redThisYear: 0, 
                    greenThisYear: 0, 
                    yellowThisYear: 0,
                    purpleThisYear: 0,
                    whiteThisYear: 0,
                    blackThisYear: 0,
                    silverThisYear: 0,

                    blueNextYear: 0, 
                    redNextYear: 0, 
                    greenNextYear: 0, 
                    yellowNextYear: 0,
                    purpleNextYear: 0,
                    whiteNextYear: 0,
                    blackNextYear: 0,
                    silverNextYear: 0,
                };
                // Define date window for statistics
                    const today = new Date();
                    const oneYearLater = new Date(today);
                    oneYearLater.setFullYear(today.getFullYear() + 1);
                    const FixedEndOfLastYear = new Date("2025-12-31");
                    const FixedEndOfThisYear = new Date("2026-12-31");
                    const FixedEndOfNextYear = new Date("2027-12-31");

                    const TargetDate = new Date("2026-08-31");

                rigs.forEach(rig => {

                    // vpMap[vp][rig].forEach(siteObj => {
                    vpMap[vp][group][rig].forEach(siteObj => {

                        //console.log("Processing siteObj:", siteObj.start);

                        const start = new Date(siteObj.start);
                        if (isNaN(start)) return; // skip invalid dates
                        const end = new Date(siteObj.start.getTime() + siteObj.duration * 86400000); // duration in days
                        const dpValue = siteObj.dp || "";
                        const isEmptyDP = !dpValue || dpValue == "";
                        const type = siteObj.type;
                        const drillok = siteObj.drillok;
                        const geook = siteObj.geook;
                        const rig = siteObj.rig;
                        const group = siteObj.group;
                        const dpReq = siteObj.dpReq;

                        const siteKey = siteObj.site.slice(0, 14);
                        const isInProgressTable = inProgressSites.has(siteKey);

                        datasets.push({
                            y: rig,
                            x: [siteObj.start, end],
                            site: siteObj.site.substring(0, 5),
                            details: {
                                Rig: rig,
                                drillok: siteObj.drillok,
                                geook: siteObj.geook,
                                VP: vp,
                                Start: siteObj.start.toLocaleDateString(),
                                Duration: siteObj.duration,
                                DP: dpValue,
                                Site: siteObj.site,
                                Well: siteObj.well,
                                dpCompany: siteObj.dpCompany,
                                ETS: siteObj.ETS,
                                type: type,
                                group: siteObj.group,
                                dpReq: dpReq,
                            }
                        });

                        const rigToAvoid = ["PRECISION 183", "PRECISION183", "PD183", "PD 183"];
                        const dpYes = dpValue === "YES" || dpValue === "YES-DP";
                        const dpNo  = !dpValue || dpValue === "NO" || dpValue === "NO-DP" || dpValue === "";

                        const countable =
                            start >= today 
                            && start <= oneYearLater 
                            //&& !rigToAvoid.includes(rig);

                        const countableForThisYear =
                            start > FixedEndOfLastYear 
                            && start <= FixedEndOfThisYear
                            //&& !rigToAvoid.includes(rig);
                            //if (countableForThisYear){console.log("Start Date:", start);}
                            
                        const countableForNextYear =
                            start > FixedEndOfThisYear 
                            && start <= FixedEndOfNextYear
                            //&& !rigToAvoid.includes(rig);
                            //if (countableForNextYear){console.log("Start Date:", start);}

                        const isForcedInProgress = isInProgressTable === true;

                        

                        // if(drillok === "NO-Drill" && geook === "NO-Geo"){
                        //     colorOfBorder = "#FFFFFF"; // white border for NO-Drill/NO-Geo
                        //     console.log("NO-Drill/NO-Geo detected for site:", drillok, geook);
                        // }



                        // Blue:    "#0084c7"   : DP-YES
                        // Green:   "#4caf50"   : FINAL 
                        // Black:     "#000000"   : PRELIM-IR
                        // Yellow:  "#ffff00"   : IN-PROGRESS
                        // Purple:  "#B11FDF"   : EXEC
                        // Red:    "#ff4c4c"   : DP-NO + Rig filter
                        // White:   "#FFFFFF"   : Fallback
                        // Silver:  "#C0C0C0"   : DP-NOT-REQUESTED


                        switch (true) {

                            case type === "FINAL":
                                colors.push("#4caf50");
                                if (countable) colorCounts.green++;
                                if (countableForThisYear) colorCounts.greenThisYear++;
                                if (countableForNextYear) colorCounts.greenNextYear++;
                                break;

                            case isForcedInProgress:
                                colors.push("#ffff00"); // IN-PROGRESS override
                                if (countable) colorCounts.yellow++;
                                if (countableForThisYear) colorCounts.yellowThisYear++;
                                if (countableForNextYear) colorCounts.yellowNextYear++;
                                break;

                            case type === "PRELIM - IR":
                                colors.push("#000000");
                                if (countable) colorCounts.black++;
                                if (countableForThisYear) colorCounts.blackThisYear++;
                                if (countableForNextYear) colorCounts.blackNextYear++;
                                break;

                            case dpNo && !rigToAvoid.includes(rig) && dpReq != "": // DP-NO and Rig filter and DpReq not empty
                                colors.push("#ff4c4c");
                                if (countable) colorCounts.red++;
                                if (countableForThisYear) colorCounts.redThisYear++;
                                if (countableForNextYear) colorCounts.redNextYear++;
                                break;

                            case type === "EXEC":
                                colors.push("#B11FDF");
                                if (countable) colorCounts.purple++;
                                if (countableForThisYear) colorCounts.purpleThisYear++;
                                if (countableForNextYear) colorCounts.purpleNextYear++;
                                break;

                            case dpYes:
                                colors.push("#0084c7");
                                if (countable) colorCounts.blue++;
                                if (countableForThisYear) colorCounts.blueThisYear++;
                                if (countableForNextYear) colorCounts.blueNextYear++;
                                break;

                            case dpReq === "" || dpReq === " ":
                                colors.push("#C0C0C0");
                                if (countable) colorCounts.silver++;
                                if (countableForThisYear) colorCounts.silverThisYear++;
                                if (countableForNextYear) colorCounts.silverNextYear++;
                                break;

                            default:
                                colors.push("#FFFFFF");
                                if (countable) colorCounts.white++;
                                if (countableForThisYear) colorCounts.whiteThisYear++;
                                if (countableForNextYear) colorCounts.whiteNextYear++;
                                break;
                        }


                    });
                });


                // -------------------------
                //  Gantt Chart
                // VP title

                const title = document.createElement("h3");
                title.textContent = `VP: ${vp}  ${group}`;
                title.style.color = "white";
                chartDiv.appendChild(title);


                // Date boundaries
                const minDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
                const maxDate = oneYearLater;

                // Canvas for Gantt
                const canvas = document.createElement("canvas");
                canvas.height = Math.max(200, rigs.length * 40);
                chartDiv.appendChild(canvas);

                const ctx = canvas.getContext("2d");
                const chart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        datasets: [{
                            label: "Schedule",
                            data: datasets,
                            backgroundColor: colors,
                            borderRadius: 6,
                            borderSkipped: false,
                            //borderColor: "#000",
                            borderColor: colorOfBorder,
                            borderWidth: 1,
                            parsing: { xAxisKey: "x", yAxisKey: "y" },
                        }]
                    },
                    options: {
                        indexAxis: "y",
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: "time",
                                time: { 
                                    unit: "day", 
                                    stepSize: 1, 
                                    tooltipFormat: "dd-MMM-yyyy", 
                                    displayFormats: { day: "dd-MMM-yy" } 
                                },
                                // min: today,
                                min: minDate,
                                // max: oneYearLater,
                                max: maxDate,
                                ticks: { color: "#ccc" },
                                grid: { color: "#333" }
                            },
                            y: {
                                type: "category",
                                labels: rigs,
                                ticks: { color: "#ccc", font: { weight: "bold" } },
                                grid: { color: "#333" }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                    const d = ctx.raw.details;
                                    return [
                                        `Site: ${d.Site}`, 
                                        `Well: ${d.Well}`,  
                                        `ETS: ${d.ETS}`,  
                                        `VP: ${d.VP}`,
                                        `Start: ${d.Start}`,
                                        `Rig: ${d.Rig}`,
                                        `Duration: ${d.Duration} days`,
                                        `DP: ${d.DP}`,
                                        `Type: ${d.type}`,
                                        `DP Company: ${d.dpCompany}`,
                                        `DrillOK: ${d.drillok}`,
                                        `GeoOK: ${d.geook}`,
                                        `Group: ${d.group}`,
                                        `DpReq: ${d.dpReq}`,
                                    ];
                                    }
                                }
                            },
                            // glowPlugin: {
                            //     glowColor: 'rgba(0, 255, 255, 0.9)',
                            //     glowBlur: 15,
                            // },
                            datalabels: {
                                anchor: "center",
                                align: "center",
                                //color: "#000",
                                color: (context) => {
                                    const bgColor = context.dataset.backgroundColor[context.dataIndex];
                                    // Determine if background is dark or light
                                    const r = parseInt(bgColor.slice(1, 3), 16);
                                    const g = parseInt(bgColor.slice(3, 5), 16);
                                    const b = parseInt(bgColor.slice(5, 7), 16);
                                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                                    return brightness < 125 ? "#fff" : "#000"; // white for dark bg, black for light bg
                                },
                                //font: { weight: "bold" },
                                font: { weight: "normal" },
                                formatter: (value) => value.site,
                            },
                            annotation: {
                                annotations: {
                                    ExeZonefutureBox: {
                                        type: "box",
                                        xMin: today,
                                        xMax: threeMonthsLater,
                                        backgroundColor: "rgba(255, 0, 0, 0.15)",
                                        borderWidth: 0.5,
                                        borderColor: "red",
                                    },
                                    handOverFutureBox: {
                                        type: "box",
                                        xMin: threeMonthsLater,
                                        xMax: fourMonthsLater,
                                        backgroundColor: "rgba(237, 255, 4, 0.15)",
                                        borderWidth: 0,
                                        borderColor: "yellow",
                                    },
                                    approvalsFutureBox: {
                                        type: "box",
                                        xMin: fourMonthsLater,
                                        xMax: sixMonthsLater,
                                        backgroundColor: "rgba(45, 147, 50, 0.15)",
                                        borderWidth: 0.5,
                                        borderColor: "green",
                                    },
                                    todayLine: {
                                        type: "line",
                                        xMin: today,
                                        xMax: today,
                                        borderColor: "red",
                                        borderWidth: 2,
                                        label: { enabled: true, content: "Today", position: "start", color: "red" },
                                    },
                                    // OneYearLaterLine: {
                                    //     type: "line",
                                    //     xMin: oneYearLater,
                                    //     xMax: oneYearLater,
                                    //     borderColor: "Yellow",
                                    //     borderWidth: 2,
                                    //     label: { enabled: true, content: "One Year", position: "end", color: "yellow" },
                                    // },
                                    FixedEndOfNextYearLine: {
                                        type: "line",
                                        xMin: FixedEndOfNextYear,
                                        xMax: FixedEndOfNextYear,
                                        borderColor: "white",
                                        borderWidth: 4,
                                        label: { enabled: true, content: "End of Next Year", position: "end", color: "white" },
                                    },
                                    FixedEndOfThisYearLine: {
                                        type: "line",
                                        xMin: FixedEndOfThisYear,
                                        xMax: FixedEndOfThisYear,
                                        borderColor: "purple",
                                        borderWidth: 4,
                                        label: { enabled: true, content: "End of This Year", position: "end", color: "purple" },
                                    },
                                    TargetDateLine: {
                                        type: "line",
                                        xMin: TargetDate,
                                        xMax: TargetDate,
                                        borderColor: "Yellow",
                                        borderWidth: 2,
                                        label: { enabled: true, content: "Target Date", position: "end", color: "yellow" },
                                    },
                                }
                            },
                            zoom: {
                                zoom: {
                                    wheel: { enabled: true },
                                    pinch: { enabled: true },
                                    mode: "x"
                                },
                                pan: {
                                    enabled: true,
                                    mode: "x",
                                    modifierKey: "ctrl"   // or "shift"
                                },
                                // limits: {
                                //     x: {
                                //     min: panMinDate,
                                //     max: panMaxDate
                                //     }
                                // },
                            },
                        },
                        barThickness: 18,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const elementIndex = elements[0].index;
                                const datasetIndex = elements[0].datasetIndex;
                                const clickedBar = chart.data.datasets[datasetIndex].data[elementIndex];
                                if (clickedBar && clickedBar.details) {
                                    let project = clickedBar.details.Site.slice(0,14);
                                    window.location.href = `/notes/findSite/${encodeURIComponent(project)}`;
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });

                chartInstances.push(chart);






                // -------------------------
                //  Summary Table + Pie
                // -------------------------

                const totalBars = 
                    colorCounts.blue +
                    colorCounts.red + 
                    colorCounts.green + 
                    colorCounts.yellow + 
                    colorCounts.purple +
                    colorCounts.white + 
                    colorCounts.silver +
                    colorCounts.black;

                const totalBarsThisYear = 
                    colorCounts.blueThisYear +
                    colorCounts.redThisYear + 
                    colorCounts.greenThisYear + 
                    colorCounts.yellowThisYear + 
                    colorCounts.purpleThisYear +
                    colorCounts.whiteThisYear + 
                    colorCounts.silverThisYear +
                    colorCounts.blackThisYear;

                const totalBarsNextYear = 
                    colorCounts.blueNextYear +
                    colorCounts.redNextYear + 
                    colorCounts.greenNextYear + 
                    colorCounts.yellowNextYear + 
                    colorCounts.purpleNextYear +
                    colorCounts.whiteNextYear + 
                    colorCounts.silverNextYear +
                    colorCounts.blackNextYear;

                // Summary Table
                    // Blue:    "#0084c7"   : DP-YES
                    // Green:   "#4caf50"   : FINAL 
                    // Black:   "#000000"   : PRELIM-IR
                    // Yellow:  "#ffff00"   : IN-PROGRESS
                    // Purple:  "#B11FDF"   : EXEC
                    // Red:     "#ff4c4c"   : DP-NO + Rig filter
                    // Silver:  "#C0C0C0"   : DP-NOT-REQUESTED
                    // White:   "#FFFFFF"   : Fallback

                


                const summaryTable = document.createElement("table");
                summaryTable.className = "table table-dark table-sm table-bordered table-hover mt-2";
                summaryTable.id = "summaryTable";
                summaryTable.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="text-center" style="color:white; background-color:#transparent"> TIME RANGE </th>
                            <th class="text-center" style="color:#020202; background-color:#0084c7"> DP-YES </th>
                            <th class="text-center" style="color:#020202; background-color:#4caf50"> FINAL </th>
                            <th class="text-center" style="color:#FFFFFF; background-color:#000000"> NEED INFO </th>
                            <th class="text-center" style="color:#020202; background-color:#ffff00"> IN PROGRESS </th>
                            <th class="text-center" style="color:#1a1a1a; background-color:#B11FDF"> HANDED OVER </th>
                            <th class="text-center" style="color:#FFFFFF; background-color:#ff4c4c"> IN QUEUE </th>
                            <th class="text-center" style="color:#020202; background-color:#FFFFFF"> ERRORS </th>
                            <th class="text-center" style="color:#020202; background-color:#c0C0C0"> NOT REQUESTED </th>
                            <th class="text-center" style="color:#FFFFFF; background-color:#transparent"> TOTAL </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center"> This Year </td>
                            <td class="text-center">${colorCounts.blueThisYear}</td>
                            <td class="text-center">${colorCounts.greenThisYear}</td>
                            <td class="text-center">${colorCounts.blackThisYear}</td>
                            <td class="text-center">${colorCounts.yellowThisYear}</td>
                            <td class="text-center">${colorCounts.purpleThisYear}</td>
                            <td class="text-center">${colorCounts.redThisYear}</td>
                            <td class="text-center">${colorCounts.whiteThisYear}</td>
                            <td class="text-center">${colorCounts.silverThisYear}</td>
                            <td class="text-center"><b>${totalBarsThisYear}</b></td>
                        </tr>
                        <tr>
                            <td class="text-center"> Next Year (Budget) </td>
                            <td class="text-center">${colorCounts.blueNextYear}</td>
                            <td class="text-center">${colorCounts.greenNextYear}</td>
                            <td class="text-center">${colorCounts.blackNextYear}</td>
                            <td class="text-center">${colorCounts.yellowNextYear}</td>
                            <td class="text-center">${colorCounts.purpleNextYear}</td>
                            <td class="text-center">${colorCounts.redNextYear}</td>
                            <td class="text-center">${colorCounts.whiteNextYear}</td>
                            <td class="text-center">${colorCounts.silverNextYear}</td>
                            <td class="text-center"><b>${totalBarsNextYear}</b></td>
                        </tr>
                    </tbody>
                </table>
                `;
                chartDiv.appendChild(summaryTable);


                const targetDateDiv = document.createElement("targetDateDiv");
                targetDateDiv.innerHTML = 
                // `<p class="mt-1 mb-0" style="font-size: 0.9em; color: #ccc;">Target Date: ${TargetDate.toLocaleDateString("en-US", { 
                //     weekday: "long", 
                //     year: "numeric", 
                //     month: "long", 
                //     day: "numeric" 
                //     })}
                // </p>`;
                `<h6 class="mt-1 mb-0" _style="font-size: 0.9em; color: #ccc;">
                    Target Date: <b> ${TargetDate.toLocaleDateString("en-US", { 
                    weekday: "long", 
                    year: "numeric", 
                    month: "long", 
                    day: "numeric" 
                    })}</b>
                </h6>
                <p class="mt-1 mb-0" style="font-size: 1.2em; color: #ccc;">
                    Days to target: <b> ${Math.ceil((TargetDate - today) / (1000 * 60 * 60 * 24))}</b>
                </p>
                <p class="mt-1 mb-0" style="font-size: 1em; color: #ccc;">
                    * Target date refers to the date by which all sites should ideally have at least a P0 for the next year 
                    and folders must be with Geo information, minimum <b> 5 months (150 days) </b> prior to this date.
                </p>
                <p class="mt-1 mb-0" style="font-size: 1.2em; color: #ccc;">
                    Max. days to request DPs for budget: <b> ${Math.ceil(((TargetDate - today) / (1000 * 60 * 60 * 24))-150)}</b>
                </p>
                `;
                chartDiv.appendChild(targetDateDiv);


                // Summary Table
                    // Blue:    "#0084c7"   : DP-YES
                    // Green:   "#4caf50"   : FINAL 
                    // Black:   "#000000"   : PRELIM-IR
                    // Yellow:  "#ffff00"   : IN-PROGRESS
                    // Purple:  "#B11FDF"   : EXEC
                    // Red:     "#ff4c4c"   : DP-NO + Rig filter
                    // Silver:  "#C0C0C0"   : DP-NOT-REQUESTED
                    // White:   "#FFFFFF"   : Fallback



                // // Pie Chart
                // const pieCanvas = document.createElement("canvas");
                // pieCanvas.style.maxWidth = "300px";
                // pieCanvas.style.maxHeight = "300px";
                // pieCanvas.className = "_mb-2";
                // chartDiv.appendChild(pieCanvas);

                // new Chart(pieCanvas.getContext("2d"), {
                //     type: "pie",
                //     data: {
                //         // labels: [
                //             // "DP/YES-DRILL/YES-GEO", 
                //             // "DP/NO-DRILL/NO-GEO", 
                //             // "DP/YES-DRILL/NO-GEO", 
                //             // "DP/NO-DRILL/YES-GEO", 
                //             // "SENT", 
                //             // "IN-PROGRESS", 
                //             // "NEED INFO", 
                //             // "OTHERS"
                //             // ],
                //         datasets: [{
                //             data: [
                //                 colorCounts.blue, // Blue:    "#0084c7"   : DP-YES
                //                 colorCounts.green, // Green:   "#4caf50"   : FINAL
                //                 colorCounts.black, // Black:   "#000000"   : PRELIM-IR
                //                 colorCounts.yellow, // Yellow:  "#ffff00"   : IN-PROGRESS
                //                 colorCounts.purple, // Purple:  "#B11FDF"   : EXEC
                //                 colorCounts.red, // Red:     "#ff4c4c"   : DP-NO + Rig filter
                //                 colorCounts.silver, // Silver:  "#C0C0C0"   : DP-NOT-REQUESTED
                //                 colorCounts.white, // White:   "#FFFFFF"   : Fallback
                //             ],
                //             backgroundColor: ["#0084c7", "#4caf50", "#000000", "#ffff00", "#B11FDF", "#ff4c4c", "#C0C0C0", "#FFFFFF"],
                //             borderColor: "#222",
                //             borderWidth: 1,
                //             datalabels: {
                //                 //align: "end",
                //                 //anchor: "end",
                //                 color: (context) => {
                //                     const bgColor = context.dataset.backgroundColor[context.dataIndex];
                //                     // Determine if background is dark or light
                //                     const r = parseInt(bgColor.slice(1, 3), 16);
                //                     const g = parseInt(bgColor.slice(3, 5), 16);
                //                     const b = parseInt(bgColor.slice(5, 7), 16);
                //                     const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                //                     return brightness < 125 ? "#fff" : "#000"; // white for dark bg, black for light bg
                //                 },
                //             }
                //         }]
                //     },
                //     options: {
                //         plugins: {
                //             title: {
                //                 display: true,
                //                 text: '1 Year Ahead From Today Statistics',
                //                 color: "#fff",
                //                 font: { size: 16, weight: "normal" }
                //             },
                //             legend: { position: "bottom", labels: { color: "#fff" } },
                //             datalabels: {
                //                 color: "#000",
                //                 font: { size: 12, weight: "normal" },
                //                 formatter: (value, ctx) => {
                //                     let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                //                     return total > 0 ? (value / total * 100).toFixed(0) + "%" : "0%";
                //                 }
                //             }
                //         }
                //     },
                //     plugins: [ChartDataLabels]
                // });


                
                const pieRow = document.createElement("div");
                pieRow.className = "pie-row";
                chartDiv.appendChild(pieRow);



                // Pie Chart 2
                const pieCanvas = document.createElement("canvas");
                pieCanvas.className = "pie-chart";
                pieRow.appendChild(pieCanvas);

                // const pieCanvas2 = document.createElement("canvas");
                // pieCanvas2.style.maxWidth = "300px";
                // pieCanvas2.style.maxHeight = "300px";
                // pieCanvas2.className = "_mb-2 m-0";

                //chartDiv.appendChild(pieCanvas);
                new Chart(pieCanvas.getContext("2d"), {
                    type: "pie",
                    data: {
                        // labels: [
                            // "DP/YES-DRILL/YES-GEO", 
                            // "DP/NO-DRILL/NO-GEO", 
                            // "DP/YES-DRILL/NO-GEO", 
                            // "DP/NO-DRILL/YES-GEO", 
                            // "SENT", 
                            // "IN-PROGRESS", 
                            // "NEED INFO", 
                            // "OTHERS"
                            // ],
                        datasets: [{
                            data: [
                                colorCounts.blueThisYear, // Blue:    "#0084c7"   : DP-YES
                                colorCounts.greenThisYear, // Green:   "#4caf50"   : FINAL
                                colorCounts.blackThisYear, // Black:   "#000000"   : PRELIM-IR
                                colorCounts.yellowThisYear, // Yellow:  "#ffff00"   : IN-PROGRESS
                                colorCounts.purpleThisYear, // Purple:  "#B11FDF"   : EXEC
                                colorCounts.redThisYear, // Red:     "#ff4c4c"   : DP-NO + Rig filter
                                colorCounts.silverThisYear, // Silver:  "#C0C0C0"   : DP-NOT-REQUESTED
                                colorCounts.whiteThisYear, // White:   "#FFFFFF"   : Fallback
                            ],
                            backgroundColor: ["#0084c7", "#4caf50", "#000000", "#ffff00", "#B11FDF", "#ff4c4c", "#C0C0C0", "#FFFFFF"],
                            borderColor: "#222",
                            borderWidth: 1,
                            datalabels: {
                                //align: "end",
                                //anchor: "end",
                                color: (context) => {
                                    const bgColor = context.dataset.backgroundColor[context.dataIndex];
                                    // Determine if background is dark or light
                                    const r = parseInt(bgColor.slice(1, 3), 16);
                                    const g = parseInt(bgColor.slice(3, 5), 16);
                                    const b = parseInt(bgColor.slice(5, 7), 16);
                                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                                    return brightness < 125 ? "#fff" : "#000"; // white for dark bg, black for light bg
                                },
                            }
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: `This Year: ${totalBarsThisYear} Wells`,
                                color: "#fff",
                                font: { size: 16, weight: "normal" }
                            },
                            legend: { position: "bottom", labels: { color: "#fff" } },
                            datalabels: {
                                color: "#000",
                                font: { size: 12, weight: "normal" },
                                formatter: (value, ctx) => {
                                    let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return total > 0 ? (value / total * 100).toFixed(0) + "%" : "0%";
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            

                // Pie Chart 3
                const pieCanvas3 = document.createElement("canvas");
                pieCanvas3.className = "pie-chart";
                pieRow.appendChild(pieCanvas3);

                // const pieCanvas3 = document.createElement("canvas");
                // pieCanvas3.style.maxWidth = "300px";
                // pieCanvas3.style.maxHeight = "300px";
                // pieCanvas3.className = "mb-2";

                //chartDiv.appendChild(pieCanvas3);
                new Chart(pieCanvas3.getContext("2d"), {
                    type: "pie",
                    data: {
                        // labels: [
                            // "DP/YES-DRILL/YES-GEO", 
                            // "DP/NO-DRILL/NO-GEO", 
                            // "DP/YES-DRILL/NO-GEO", 
                            // "DP/NO-DRILL/YES-GEO", 
                            // "SENT", 
                            // "IN-PROGRESS", 
                            // "NEED INFO", 
                            // "OTHERS"
                            // ],
                        datasets: [{
                            data: [
                                colorCounts.blueNextYear, // Blue:    "#0084c7"   : DP-YES
                                colorCounts.greenNextYear, // Green:   "#4caf50"   : FINAL
                                colorCounts.blackNextYear, // Black:   "#000000"   : PRELIM-IR
                                colorCounts.yellowNextYear, // Yellow:  "#ffff00"   : IN-PROGRESS
                                colorCounts.purpleNextYear, // Purple:  "#B11FDF"   : EXEC
                                colorCounts.redNextYear, // Red:     "#ff4c4c"   : DP-NO + Rig filter
                                colorCounts.silverNextYear, // Silver:  "#C0C0C0"   : DP-NOT-REQUESTED
                                colorCounts.whiteNextYear, // White:   "#FFFFFF"   : Fallback
                            ],
                            backgroundColor: ["#0084c7", "#4caf50", "#000000", "#ffff00", "#B11FDF", "#ff4c4c", "#C0C0C0", "#FFFFFF"],
                            borderColor: "#222",
                            borderWidth: 1,
                            datalabels: {
                                //align: "end",
                                //anchor: "end",
                                color: (context) => {
                                    const bgColor = context.dataset.backgroundColor[context.dataIndex];
                                    // Determine if background is dark or light
                                    const r = parseInt(bgColor.slice(1, 3), 16);
                                    const g = parseInt(bgColor.slice(3, 5), 16);
                                    const b = parseInt(bgColor.slice(5, 7), 16);
                                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                                    return brightness < 125 ? "#fff" : "#000"; // white for dark bg, black for light bg
                                },
                            }
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: `Next Year (Budget): ${totalBarsNextYear} Wells`,
                                color: "#fff",
                                font: { size: 16, weight: "normal" }
                            },
                            legend: { position: "bottom", labels: { color: "#fff" } },
                            datalabels: {
                                color: "#000",
                                font: { size: 12, weight: "normal" },
                                formatter: (value, ctx) => {
                                    let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return total > 0 ? (value / total * 100).toFixed(0) + "%" : "0%";
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });

            
            });
        });
    }

    //// window.addEventListener("DOMContentLoaded", renderChartsFromTable);


</script>




<script>
    async function loadScheduleAndNotes() {
        try {
            const res = await fetch("/notes/getScheduleAndNotes");
            const data = await res.json();

            // Save into objects
            const scheduleObj = {};
            data.schedule.forEach(item => {
            scheduleObj[item._id] = item;  // keyed by schedule _id
            });

            const notesObj = {};
            data.notes.forEach(note => {
            notesObj[note._id] = note; // keyed by note _id
            });

            console.log(" Schedule Object:", scheduleObj);
            console.log(" Notes Object:", notesObj);

            alert("Schedule & Notes loaded. Check console for objects.");
        } catch (err) {
            console.error("Error loading schedule & notes:", err);
        }
    }
</script>








<script>
    async function appendNoteIds() {
        try {
            // Fetch all schedule + notes
            const res = await fetch("/notes/getScheduleAndNotes");
            const data = await res.json();

            const notes = data.notes;

            ////Build a lookup map for Note.project  { noteId, mtxJobId }
            const notesMap = {};
            notes.forEach(note => {
                if (note.project) {
                    const key = note.project.slice(0, 14); // normalize
                    if (!notesMap[key]) {
                        notesMap[key] = {
                            noteId: note._id,
                            mtxJobId: note.mtxJobId || null
                        };
                    }
                }
            });            

            // Find the table
            const table = document.getElementById("csvTable");
            if (!table) return alert("Table not found!");

            // Add headers if not already present
            const headerRow = table.querySelector("thead tr");
            if (!headerRow.querySelector("th.noteid-col")) {
                const th = document.createElement("th");
                th.textContent = "NoteID";
                th.classList.add("noteid-col");
                headerRow.appendChild(th);
            }
            if (!headerRow.querySelector("th.mtxjobid-col")) {
                const th = document.createElement("th");
                th.textContent = "mtxJobId";
                th.classList.add("mtxjobid-col");
                headerRow.appendChild(th);
            }

            // Add rows with NoteID + mtxJobId
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const cells = row.querySelectorAll("td");
                // if (cells.length < 7) return; // skip malformed rows
                if (cells.length < 8) return; // skip malformed rows <-- updated for new column count

                //const site = cells[6].textContent.trim().slice(0, 14); // schedule site normalized
                const site = cells[7].textContent.trim().slice(0, 14); // schedule site normalized <-- updated for new column count
                const noteData = notesMap[site];

                // --- NoteID cell ---
                const tdNote = document.createElement("td");
                if (noteData?.noteId) {
                    const link = document.createElement("a");
                    link.href = `/notes/job/${noteData.noteId}`;
                    link.textContent = noteData.noteId;
                    link.style.color = "aqua";
                    link.style.textDecoration = "none";
                    tdNote.appendChild(link);
                } else {
                    tdNote.textContent = "Not Found";
                    tdNote.style.color = "red";
                }
                row.appendChild(tdNote);

                // --- mtxJobId cell ---
                const tdMtx = document.createElement("td");
                if (noteData?.mtxJobId) {
                    tdMtx.textContent = noteData.mtxJobId;
                    tdMtx.style.color = "lime";
                } else {
                    tdMtx.textContent = "Not Found";
                    tdMtx.style.color = "orange";
                }
                row.appendChild(tdMtx);
            });

            console.log(" Note IDs and mtxJobIds appended to table");
        } catch (err) {
            console.error("Error appending Note IDs:", err);
        }
    }
</script>











<script>
    async function syncDueDates() {
        try {
            const res = await fetch("/notes/syncDueDates");
            const data = await res.json();
            alert(` Synced ${data.updated} notes with schedule start dates`);
            location.reload(); // reload to reflect changes
        } catch (err) {
            console.error("Error syncing due dates:", err);
            alert(" Sync failed, check console");
        }
    }
</script>










<script>
    function renderDPStatsBoxPlot() {
        const versions = [];
        const days = [];

        document.querySelectorAll("#DPStatsTable tbody tr").forEach(row => {
            versions.push(row.cells[0].innerText.trim());
            days.push(Number(row.cells[1].innerText.trim()));
        });

        Plotly.newPlot("dpBoxPlot", [{
            y: days,
            x: versions,
            type: "box",
            boxpoints: "outliers",
            marker: { color: "#0084c7" }
        }], {
            title: "DP Timing Statistics",
            // yaxis: { title: "DP Days" },
            yaxis: {
                title: "Days",
                range: [0, 60],      //  LIMIT TO 60 DAYS
                fixedrange: false    //  prevents zooming beyond this range
            },
            xaxis: { title: "Version" },
            // paper_bgcolor: "#111",
            // plot_bgcolor: "#111",
            paper_bgcolor : 'rgba(0,0,0,0)',
            plot_bgcolor : 'rgba(0,0,0,0)',
            font: { color: "#fff" },
        });
    }
</script>







<%- include ('partials/footer.ejs') %>

<!--  -->